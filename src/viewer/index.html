<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, height=device-height" />
    <title>weightwatcher</title>

    <style type="text/css">
        /* TODO */
    </style>

    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
</head>
<body>

    <div id="container" style="min-width: 300px; height: 500px; margin: 0 auto"></div>

    <script>
        (function() { "use strict";

            $.getJSON('weightwatcher-data.json', function(data) {
                renderChart(combineSeries(data));
            });

            return;

            function combineSeries(rawData) {
                var series = getSLOCSeries(rawData);
                series.forEach(function(currentSeries) {
                    currentSeries.data.sort(function(a, b) {
                        return a[0] - b[0]; // sort by timestamps
                    });
                });
                return series;
            }

            function getSLOCSeries(rawData) {
                var seriesMap = {};
                Object.keys(rawData).forEach(function(identity) {
                    var entry = rawData[identity];
                    Object.keys(entry.sloc).forEach(function(category) { // e.g. "Web code"
                        Object.keys(entry.sloc[category]).forEach(function(metric) { // e.g. "files"
                            var key = category + ': ' + metric;
                            if (!seriesMap[key]) {
                                seriesMap[key] = [];
                            }
                            seriesMap[key].push(
                                [ new Date(identity).getTime(), entry.sloc[category][metric] ]
                            );
                        });
                    });
                });
                return Object.keys(seriesMap).map(function(key) {
                    return {
                        type: 'line',
                        name: key,
                        data: seriesMap[key]
                    };
                });
            }

            function renderChart(series) {

                $('#container').highcharts({
                    chart: {
                        zoomType: 'x',
                        spacingRight: 20
                    },
                    title: {
                        text: 'Weightwatcher'
                    },
                    subtitle: {
                        text: document.ontouchstart === undefined ?
                            'Click and drag in the plot area to zoom in' :
                            'Pinch the chart to zoom in'
                    },
                    xAxis: {
                        type: 'datetime',
                        maxZoom: 1 * 24 * 3600000, // 1 day
                        title: {
                            text: null
                        }
                    },
                    yAxis: {
                        allowDecimals: false,
                        min: 0,
                        title: {
                            text: null
                        }
                    },
                    tooltip: {
                        shared: true
                    },
                    legend: {
                        layout: 'vertical',
                        align: 'right',
                        verticalAlign: 'middle',
                        borderWidth: 0
                    },
                    plotOptions: {
                        line: {
                            lineWidth: 1,
                            marker: {
                                enabled: false
                            },
                            shadow: false,
                            states: {
                                hover: {
                                    lineWidth: 1
                                }
                            },
                            threshold: null
                        }
                    },
                    series: series
                });

            }

        })();
    </script>

</body>
</html>
